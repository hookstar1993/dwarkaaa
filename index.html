<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jay Dwarkadhish - Poonam Schedule - Views Bookings</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@400;600&family=Jost:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        html {
            scroll-behavior: smooth;
        }

        /* --- THEME ENGINE & FONT SETUP --- */
        body {
            font-family: 'Jost', sans-serif;
            background-attachment: fixed;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            cursor: default;
        }

        h1,
        h2.page-title,
        #countdown-timer span {
            font-family: 'Teko', sans-serif;
            letter-spacing: 0.05em;
        }

        /* Glassmorphism Card Style */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.1);
            transition: background 0.3s, border 0.3s;
        }

        /* --- Light Theme --- */
        .light {
            --bg-gradient-start: #FFF1E4;
            --bg-gradient-end: #FAD4C4;
            --text-primary: #4A2E1A;
            --text-secondary: #8C5B3F;
            --glass-bg: rgba(255, 255, 255, 0.4);
            --glass-border: rgba(255, 255, 255, 0.6);
            --accent-color: #FF7B54;
            --modal-overlay: rgba(58, 46, 32, 0.5);
            --input-bg: rgba(255, 255, 255, 0.7);
            --current-timing-bg: rgba(255, 123, 84, 0.1);
        }
        .light body {
            background-image: linear-gradient(120deg, var(--bg-gradient-start), var(--bg-gradient-end));
        }
        .light select option {
            background: var(--bg-gradient-start);
            color: var(--text-primary);
        }

        /* --- Dark Theme --- */
        .dark {
            --bg-gradient-start: #121212;
            --bg-gradient-end: #181818;
            --text-primary: #F0E6D8;
            --text-secondary: #A89C8C;
            --glass-bg: rgba(30, 40, 50, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
            --accent-color: #FFA781;
            --modal-overlay: rgba(0, 0, 0, 0.6);
            --input-bg: rgba(255, 255, 255, 0.05);
            --current-timing-bg: rgba(255, 167, 129, 0.1);
        }
        .dark body {
            background-image: linear-gradient(120deg, var(--bg-gradient-start), var(--bg-gradient-end));
        }
        .dark select option {
            background: var(--bg-gradient-end);
            color: var(--text-primary);
        }

        /* Themed elements */
        .theme-text-primary { color: var(--text-primary); }
        .theme-text-secondary { color: var(--text-secondary); }
        .theme-accent-color { color: var(--accent-color); }

        /* --- COMPONENT STYLES --- */

        .ios-button {
            position: relative;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            transition: all 0.2s ease-in-out;
            cursor: pointer;
        }
        .ios-button:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        .ios-button:active {
            transform: translateY(0) scale(1);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);
        }

        .pay-button {
            background-color: var(--accent-color);
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
            box-shadow: 0 4px 15px -5px var(--accent-color);
            transition: all 0.2s ease-in-out;
        }
        .pay-button:hover {
            transform: translateY(-2px) scale(1.05);
            box-shadow: 0 8px 25px -8px var(--accent-color);
        }


        .animated-glow-border {
            position: relative; overflow: hidden; z-index: 10;
        }
        .animated-glow-border::before {
            content: ''; position: absolute; top: 0; left: -150%;
            width: 150%; height: 100%;
            background: linear-gradient(110deg, transparent 20%, color-mix(in srgb, var(--accent-color) 40%, transparent) 50%, transparent 80%);
            transform: skewX(-25deg);
            animation: animate-glow 4s linear infinite;
        }
        @keyframes animate-glow { from { left: -150%; } to { left: 150%; } }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--modal-overlay); z-index: 50;
            display: flex; align-items: center; justify-content: center;
            transition: opacity 0.3s ease;
        }
        .modal-content, .modal-content-ticket {
            transform: scale(0.95); opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        /* New responsive class for Places Modal */
        .modal-content-places {
            width: 95%; /* Mobile width */
            max-width: 1100px; /* Desktop max width */
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
        }
        .modal-backdrop:not(.hidden) .modal-content,
        .modal-backdrop:not(.hidden) .modal-content-ticket,
        .modal-backdrop:not(.hidden) .modal-content-places {
            transform: scale(1); opacity: 1;
        }
        .modal-content { width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        .modal-content-ticket { width: 90%; height: 90%; max-width: 1000px; }
        .modal-iframe { width: 100%; height: calc(100% - 60px); border: none; }

        .current-timing {
            background-color: var(--current-timing-bg);
            border-left: 4px solid var(--accent-color);
        }

        .welcome-popup-container {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.5s ease-in-out;
        }
        .welcome-popup-visible { opacity: 1; }
        .welcome-content {
            padding: 2rem; text-align: center;
            transform: scale(0.9); transition: transform 0.5s ease-in-out;
        }
        .welcome-content-visible { transform: scale(1); }

        .train-container {
            position: relative; width: 100%; height: 96px;
            display: flex; align-items: center; justify-content: center;
        }
        .train-track {
            position: absolute; width: 100%; height: 2px;
            background-color: var(--glass-border); top: 50%;
            transform: translateY(-50%); z-index: 5;
        }
        .train {
            position: absolute; top: 50%; left: 0;
            transform: translateY(-50%);
            animation: move-train 4s linear infinite;
            z-index: 15;
        }
        @keyframes move-train { 0% { left: -12px; } 100% { left: calc(100% - 12px); } }

        .ticket-card { position: relative; transition: transform 0.3s, box-shadow 0.3s; }
        .ticket-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.2);
        }
        .ticket-card::before, .ticket-card::after {
            content: ''; position: absolute; top: 50%;
            width: 40px; height: 40px;
            border-radius: 50%; z-index: 20;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.2);
        }
        .dark .ticket-card::before, .dark .ticket-card::after { background: var(--bg-gradient-end); }
        .light .ticket-card::before, .light .ticket-card::after { background: var(--bg-gradient-end); }
        .ticket-card::before { left: 0; transform: translate(-50%, -50%); }
        .ticket-card::after { right: 0; transform: translate(50%, -50%); }

        #toast-notification {
            position: fixed; bottom: 1.25rem; left: 50%;
            transform: translate(-50%, 5rem); opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
        }
        #toast-notification.show { transform: translate(-50%, 0); opacity: 1; pointer-events: auto; }

        /* --- COUNTDOWN TIMER --- */
        /* --- UPDATED COUNTDOWN TIMER --- */
        .countdown-item {
            background-image: url('https://hookstar1993.github.io/dwarka/img/moon.png');
            background-color: transparent; /* Explicitly remove any background color */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            border-radius: 1rem;
            padding: 0.5rem;
            width: 100px;
            height: 100px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            box-shadow: none; /* Remove shadow */
            border-radius: 0; /* Remove border-radius to prevent any shape */
        }
        .countdown-item span {
            color: black;
            text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
        }
        .countdown-item p {
            color: black;
            font-weight: 600;
        }

        .status-duration-circle {
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        /* --- CARD ANIMATION --- */
        .card-item {
            opacity: 0;
            transform: translateY(30px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }
        .card-item.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* --- COLLAPSIBLE CARD STYLES --- */
        .collapsible-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-in-out;
        }
        .chevron-icon {
            transition: transform 0.3s ease-in-out;
        }
        .collapsible-trigger.active .chevron-icon {
            transform: rotate(180deg);
        }

        /* Places Modal Styles */
        .place-card {
            transition: all 0.3s ease;
        }
        .place-card:hover {
            transform: translateY(-3px);
        }

        @media (max-width: 640px) {
            .countdown-item {
                width: 70px; height: 70px;
            }
            #countdown-timer { gap: 0.5rem; }
            .ticket-card::before, .ticket-card::after {
                width: 30px; height: 30px;
            }
        }
    </style>
</head>
<body class="flex flex-col min-h-screen theme-text-primary transition-colors duration-500">

    <!-- Welcome Popup -->
    <div id="welcome-popup" class="welcome-popup-container">
        <div class="welcome-content glass-card">
            <h2 class="text-4xl sm:text-5xl font-bold theme-accent-color page-title">Jay Dwarkadhish üôè</h2>
            <p id="slogan-text" class="theme-text-secondary mt-2 text-xl font-bold min-h-[3rem] flex items-center justify-center">Welcome to the sacred journey!</p>
        </div>
    </div>

    <!-- Main Site Wrapper -->
    <div id="site-wrapper" class="opacity-100 transition-opacity duration-500">
        <header class="glass-card fixed top-4 left-4 right-4 z-40 transition-all duration-300">
            <nav class="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
                <div class="flex items-center text-xl sm:text-2xl font-bold tracking-wider theme-text-primary">
                    <svg class="w-8 h-8 mr-2 theme-accent-color" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M3 20h18" /><path d="M7 20L12 5l5 15" /><path d="M12 5V2l5 1.5L12 2" /><path d="M8 20v-3h8v3" />
                    </svg>
                    Jay Dwarkadhish
                </div>
                <div class="flex items-center space-x-2">
                    <div class="hidden md:flex items-center space-x-6">
                        <a href="#" id="home-link" class="theme-text-secondary hover:theme-text-primary font-medium transition-colors duration-300">Home</a>
                        <!-- NEW NEARBY PLACES LINK -->
                        <a href="#" id="places-link" class="theme-text-secondary hover:theme-text-primary font-medium transition-colors duration-300 flex items-center gap-1">
                            <i class="fas fa-map-location-dot text-sm"></i> Nearby Places
                        </a>
                        <a href="#" id="timing-link" class="theme-text-secondary hover:theme-text-primary font-medium transition-colors duration-300">Mandir Timing</a>
                        <a href="#" id="about-link" class="theme-text-secondary hover:theme-text-primary font-medium transition-colors duration-300">About Us</a>
                        <a href="#" id="contact-link" class="theme-text-secondary hover:theme-text-primary font-medium transition-colors duration-300">Contact</a>
                        <a href="#" id="pay-link" class="pay-button font-bold py-2 px-4 rounded-xl">Pay Me Here</a>
                    </div>
                    <!-- Theme Toggle -->
                    <button id="theme-toggle" title="Toggle Theme" class="p-2 rounded-full hover:bg-black/10 dark:hover:bg-white/10 transition-colors">
                        <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="theme-text-secondary"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>
                        <svg id="moon-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="hidden theme-text-secondary"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
                    </button>
                    <button class="md:hidden" id="mobile-menu-button">
                        <svg class="w-6 h-6 theme-text-primary" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
                    </button>
                </div>
            </nav>
            <div id="mobile-menu" class="hidden md:hidden px-6 pb-4 glass-card rounded-b-2xl -mt-2">
                 <a href="#" id="mobile-home-link" class="block py-2 text-center theme-text-secondary hover:theme-text-primary">Home</a>
                 <a href="#" id="mobile-places-link" class="block py-2 text-center theme-text-secondary hover:theme-text-primary">Nearby Places</a>
                 <a href="#" id="mobile-timing-link" class="block py-2 text-center theme-text-secondary hover:theme-text-primary">Mandir Timing</a>
                 <a href="#" id="mobile-about-link" class="block py-2 text-center theme-text-secondary hover:theme-text-primary">About Us</a>
                 <a href="#" id="mobile-contact-link" class="block py-2 text-center theme-text-secondary hover:theme-text-primary">Contact</a>
                 <a href="#" id="mobile-pay-link" class="pay-button block py-2 mt-2 text-center font-bold rounded-xl transition-all duration-300">Pay Me Here</a>
            </div>
        </header>

        <main id="content-area" class="container mx-auto px-4 sm:px-6 pt-24 md:pt-28 pb-12 flex-grow">
            <div id="main-view">
                <section class="text-center mb-12">
                    <h1 class="text-4xl sm:text-5xl font-black theme-text-primary leading-tight" style="text-shadow: 0 2px 4px rgba(0,0,0,0.1);">üåï Our Spiritual Journey to Dwarka Begins!</h1>
                    <p class="text-base sm:text-lg theme-text-secondary mt-4 max-w-3xl mx-auto">Join our sacred pilgrimage on these special Poonam days! Stay updated with all travel and booking details below.</p>
                </section>

                <!-- Countdown Timer -->
                <section id="countdown-container" class="mb-12 sm:mb-16">
                    <!-- Timer will be injected here -->
                </section>

                <!-- DROPDOWN MENUS -->
                <section class="w-full max-w-xl mx-auto mb-12">
                    <div class="glass-card overflow-hidden p-4 flex flex-col sm:flex-row justify-center items-center gap-4">
                        <div class="w-full sm:w-1/2">
                            <label for="year-filter" class="block text-sm font-bold theme-text-secondary mb-1 text-center">Select Year:</label>
                            <select id="year-filter" class="block w-full px-3 py-2 text-base rounded-md focus:outline-none theme-text-primary" style="background:var(--input-bg); border: 1px solid var(--glass-border);">
                                <!-- Year options will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="w-full sm:w-1/2">
                            <label for="date-month-filter" class="block text-sm font-bold theme-text-secondary mb-1 text-center">Select Date & Month:</label>
                            <select id="date-month-filter" class="block w-full px-3 py-2 text-base rounded-md focus:outline-none theme-text-primary" style="background:var(--input-bg); border: 1px solid var(--glass-border);" disabled>
                                <!-- Date/Month options will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </section>

                <!-- DETAILED BOOKING CARDS WILL BE LOADED HERE -->
                <section id="poonam-dates-container" class="space-y-8">
                    <!-- Cards will be dynamically added here -->
                </section>
            </div>
        </main>

        <footer class="text-center pb-8 px-4">
            <p class="text-sm theme-text-secondary mb-4">¬© 2025 Jay Dwarkadhish. All Rights Reserved.</p>
            <div class="flex justify-center space-x-6">
                <a href="#" class="theme-text-secondary hover:theme-text-primary transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.04C6.5 2.04 2 6.53 2 12.06c0 4.71 3.21 8.65 7.53 9.79v-6.94H7.01v-2.85h2.52V9.82c0-2.5 1.52-3.88 3.78-3.88 1.08 0 2.02.08 2.29.12v2.54h-1.5c-1.21 0-1.45.58-1.45 1.42v1.86h2.83l-.37 2.85h-2.46v6.94C18.79 20.71 22 16.77 22 12.06c0-5.53-4.5-10.02-10-10.02z"/></svg></a>
                <a href="#" class="theme-text-secondary hover:theme-text-primary transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M22.46 6c-.77.35-1.6.58-2.46.67.88-.53 1.56-1.37 1.88-2.38-.83.49-1.75.85-2.72 1.05C18.37 4.5 17.26 4 16 4c-2.35 0-4.27 1.92-4.27 4.29 0 .34.04.67.11.98-3.56-.18-6.72-1.88-8.84-4.48-.37.63-.58 1.37-.58 2.15 0 1.49.75 2.81 1.91 3.58-.7-.02-1.37-.22-1.95-.55v.05c0 2.08 1.48 3.82 3.44 4.21a4.22 4.22 0 0 1-1.94.07 4.28 4.28 0 0 0 4 2.98 8.521 8.521 0 0 1-5.33 1.84c-.34 0-.68-.02-1.02-.06C3.44 20.29 5.7 21 8.12 21c7.55 0 11.69-6.25 11.69-11.69v-.53c.8-.58 1.48-1.3 2.02-2.12z"/></svg></a>
                <a href="#" class="theme-text-secondary hover:theme-text-primary transition-colors"><svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24"><path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8A3.6 3.6 0 0 0 7.6 20h8.8A3.6 3.6 0 0 0 20 16.4V7.6A3.6 3.6 0 0 0 16.4 4H7.6m9.65 1.5a1.25 1.25 0 1 1-2.5 0 1.25 1.25 0 0 1 2.5 0M12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10m0 2a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg></a>
            </div>
        </footer>
    </div>

    <!-- Ticket Viewer Modal -->
    <div id="ticketModal" class="modal-backdrop hidden">
        <div class="modal-content-ticket glass-card p-2 sm:p-4 relative flex flex-col">
            <button id="closeModalBtn" class="ios-button !bg-red-600/80 absolute -top-2 -right-2 sm:-top-3 sm:-right-3 text-white rounded-full h-8 w-8 flex items-center justify-center text-lg font-bold z-50 hover:!bg-red-700 transition-all">&times;</button>
            <iframe id="ticketViewerIframe" class="modal-iframe flex-grow rounded-t-lg" src="" title="Ticket Viewer"></iframe>
            <div class="text-center p-2">
                <a id="downloadBtn" href="#" download class="w-full sm:w-auto inline-block animated-glow-border ios-button px-6 py-2 rounded-xl transition-all duration-300" style="color:var(--accent-color)">Download</a>
            </div>
        </div>
    </div>

    <!-- Nearby Places Modal -->
    <div id="places-modal" class="modal-backdrop hidden">
        <div class="modal-content-places glass-card p-6 relative flex flex-col h-[90vh]">
            <button id="close-places-modal" class="absolute top-4 right-4 theme-text-secondary hover:theme-text-primary transition-colors text-3xl z-50">&times;</button>
            <h2 class="text-3xl font-bold theme-accent-color page-title mb-6 text-center">Nearby Places to Visit</h2>
            
            <div id="places-container" class="overflow-y-auto pr-2 space-y-4">
                <!-- Places will be loaded here -->
                <div class="text-center p-8">
                    <p class="theme-text-secondary">Loading places...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- About Us Modal -->
    <div id="about-modal" class="modal-backdrop hidden">
        <div class="modal-content glass-card p-6 sm:p-8 relative flex flex-col">
            <button id="close-about-modal" class="absolute top-4 right-4 theme-text-secondary hover:theme-text-primary transition-colors text-3xl">&times;</button>
            <h2 class="text-3xl font-bold theme-accent-color page-title mb-4">About Us</h2>
            <div class="theme-text-secondary overflow-y-auto pr-4 space-y-4">
                <h3 class="text-2xl font-bold theme-accent-color">Welcome to Jay Dwarkadhish‚Äôs Sacred Pilgrimage</h3>
                <p>At Jay Dwarkadhish, we bring together a community of seekers who embark on a spiritual journey to Dwarka during auspicious Poonam (full-moon) occasions. Rooted in devotion and fellowship, our mission is to facilitate this sacred pilgrimage with warmth, ease, and purpose.</p>
                <h3 class="text-2xl font-bold theme-accent-color mt-6">What We Offer:</h3>
                <ul class="list-disc list-inside space-y-2">
                    <li><span class="font-semibold theme-text-primary">Curated Yatra Travel:</span> Comprehensive bookings and logistics aligned with special Poonam days to ensure serene and hassle-free travel.</li>
                    <li><span class="font-semibold theme-text-primary">Community Focus:</span> A heartfelt space for devotees to connect, share, and experience the spiritual richness of Dwarka together.</li>
                </ul>
                <h3 class="text-2xl font-bold theme-accent-color mt-6">About the Organizers</h3>
                <p>The journey is organized by <span class="font-semibold theme-text-primary">Hardeep Savani</span> from Surat, Gujarat. With a deep reverence for our spiritual heritage and a passion for community, Hardeep is committed to guiding everyone on a blessed and memorable pilgrimage.</p>

                <h3 class="text-2xl font-bold theme-accent-color mt-6">New Features & Updates</h3>
                <ul class="list-disc list-inside space-y-2">
                    <li><span class="font-semibold theme-text-primary">Nearby Places Guide:</span> Explore famous places around Dwarka with distance, timings, and map links.</li>
                    <li><span class="font-semibold theme-text-primary">Live Train Status:</span> Click on the Train Name to see live running status instantly.</li>
                    <li><span class="font-semibold theme-text-primary">Smart PNR:</span> Click on PNR Number to check status or use the copy button.</li>
                    <li><span class="font-semibold theme-text-primary">Location Map:</span> Added "View on Google Maps" link for Hotels & Dharamshalas.</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div id="contact-modal" class="modal-backdrop hidden">
        <div class="modal-content glass-card p-6 sm:p-8 relative flex flex-col">
            <button id="close-contact-modal" class="absolute top-4 right-4 theme-text-secondary hover:theme-text-primary transition-colors text-3xl">&times;</button>
            <h2 class="text-3xl font-bold theme-accent-color page-title mb-4">Contact & Suggestions</h2>
            <div class="theme-text-secondary mb-6">
                <p class="font-semibold text-lg theme-text-primary">Hardeep Savani</p>
                <p>Surat, Gujarat</p>
            </div>
            <div class="flex items-center justify-center space-x-6 mb-8">
                <a href="https://wa.me/919824594156" target="_blank" class="flex items-center space-x-2 text-green-400 hover:text-green-300 transition-colors"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654z"/></svg><span class="font-semibold">WhatsApp</span></a>
                <a href="https://instagram.com/hookstar.fx" target="_blank" class="flex items-center space-x-2 text-pink-400 hover:text-pink-300 transition-colors"><svg class="w-8 h-8" fill="currentColor" viewBox="0 0 24 24"><path d="M7.8 2h8.4C19.4 2 22 4.6 22 7.8v8.4a5.8 5.8 0 0 1-5.8 5.8H7.8C4.6 22 2 19.4 2 16.2V7.8A5.8 5.8 0 0 1 7.8 2m-.2 2A3.6 3.6 0 0 0 4 7.6v8.8A3.6 3.6 0 0 0 7.6 20h8.8A3.6 3.6 0 0 0 20 16.4V7.6A3.6 3.6 0 0 0 16.4 4H7.6m9.65 1.5a1.25 1.25 0 1 1-2.5 0 1.25 1.25 0 0 1 2.5 0M12 7a5 5 0 1 1 0 10 5 5 0 0 1 0-10m0 2a3 3 0 1 0 0 6 3 3 0 0 0 0-6z"/></svg><span class="font-semibold">Instagram</span></a>
            </div>
            <form id="contact-form" action="https://formspree.io/f/xovlkbqr" method="POST" class="space-y-4">
                <input type="text" name="name" id="contact-name" placeholder="Your Name" class="w-full p-2 rounded-lg border theme-text-primary focus:outline-none" style="background: var(--input-bg); border-color: var(--glass-border);" required>
                <input type="email" name="email" id="contact-email" placeholder="Your Email" class="w-full p-2 rounded-lg border theme-text-primary focus:outline-none" style="background: var(--input-bg); border-color: var(--glass-border);" required>
                <textarea name="message" id="contact-message" placeholder="Your Suggestion..." rows="4" class="w-full p-2 rounded-lg border theme-text-primary focus:outline-none" style="background: var(--input-bg); border-color: var(--glass-border);" required></textarea>
                <button type="submit" class="ios-button w-full p-3 rounded-xl text-center font-semibold transition-all duration-300 hover:shadow-xl transform hover:scale-105" style="background:var(--accent-color); color:white;">Send Suggestion</button>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="payment-modal" class="modal-backdrop hidden">
        <div class="modal-content glass-card p-6 sm:p-8 relative flex flex-col max-h-[90vh] overflow-y-auto">
            <button id="close-payment-modal" class="absolute top-4 right-4 theme-text-secondary hover:theme-text-primary transition-colors text-3xl">&times;</button>
            <div class="text-center">
                <h1 class="text-2xl sm:text-3xl font-bold theme-text-primary tracking-tight">Make a Secure Payment</h1>
                <p class="theme-text-secondary mt-2 text-sm sm:text-base">Click a button to pay with your preferred mobile app. (Mobile only)</p>
            </div>
            <div class="space-y-4 mt-8">
                <h2 class="text-lg font-semibold theme-accent-color">1. Pay Directly via App</h2>
                <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <a href="upi://pay?pa=9824594156@okbizaxis&pn=Your%20Name&cu=INR" class="ios-button p-4 rounded-xl flex flex-col items-center justify-center space-y-2"><div class="h-8 flex items-center"><img src="https://upload.wikimedia.org/wikipedia/commons/thumb/f/f2/Google_Pay_Logo.svg/2560px-Google_Pay_Logo.svg.png" alt="Google Pay" class="h-full w-auto object-contain"></div><span class="font-semibold theme-text-primary text-xs">Google Pay</span></a>
                    <a href="phonepe://pay?pa=9824594156@okbizaxis&pn=Your%20Name&cu=INR" class="ios-button p-4 rounded-xl flex flex-col items-center justify-center space-y-2"><div class="h-8 flex items-center"><img src="https://upload.wikimedia.org/wikipedia/commons/7/71/PhonePe_Logo.svg" alt="PhonePe" class="h-full w-auto object-contain"></div><span class="font-semibold theme-text-primary text-xs">PhonePe</span></a>
                    <a href="bhim://upi/pay?pa=9824594156@okbizaxis&pn=Your%20Name&cu=INR" class="ios-button p-4 rounded-xl flex flex-col items-center justify-center space-y-2"><div class="h-8 flex items-center"><img src="https://upload.wikimedia.org/wikipedia/en/6/65/BHIM_SVG_Logo.svg" alt="BHIM UPI" class="h-full w-auto object-contain"></div><span class="font-semibold theme-text-primary text-xs">BHIM</span></a>
                </div>
            </div>
            <div class="relative my-6"><div class="absolute inset-0 flex items-center"><div class="w-full" style="border-top:1px solid var(--glass-border)"></div></div><div class="relative flex justify-center"><span class="px-2 text-sm theme-text-secondary" style="background:var(--glass-bg)">OR</span></div></div>
            <div class="space-y-4">
                <h2 class="text-lg font-semibold theme-accent-color">2. Scan & Pay</h2>
                <div class="bg-white/90 p-4 rounded-lg flex justify-center"><img src="https://hookstar1993.github.io/paymehook/qr-9824594156@okbizaxis.png" alt="QR Code for Payment" class="rounded-md w-full max-w-[200px]"></div>
            </div>
            <div class="space-y-4 mt-6">
                <h2 class="text-lg font-semibold theme-accent-color">3. Pay with UPI ID</h2>
                <div class="p-4 rounded-lg flex justify-between items-center" style="background:var(--input-bg)">
                    <span id="upiId" class="font-medium theme-text-primary text-sm sm:text-base break-all">9824594156@okbizaxis</span>
                    <button onclick="copyToClipboard('upiId', this)" title="Copy UPI ID" class="ios-button p-1.5 rounded-xl flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 theme-text-primary" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg></button>
                </div>
            </div>
            <div class="space-y-4 mt-6">
                <h2 class="text-lg font-semibold theme-accent-color">4. Direct Bank Transfer</h2>
                <div class="p-4 rounded-lg space-y-4 text-sm sm:text-base" style="background:var(--input-bg)">
                    <div class="flex justify-between items-center"><span class="theme-text-secondary">Account Name:</span><div class="flex items-center space-x-3"><span id="accName" class="font-medium theme-text-primary text-right">SAVANI HARDEEP M.</span><button onclick="copyToClipboard('accName', this)" title="Copy Account Name" class="ios-button p-1.5 rounded-xl flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 theme-text-primary" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg></button></div></div>
                    <div class="flex justify-between items-center"><span class="theme-text-secondary">Bank Name:</span><div class="flex items-center space-x-3"><span id="bankName" class="font-medium theme-text-primary text-right">STATE BANK OF INDIA</span><button onclick="copyToClipboard('bankName', this)" title="Copy Bank Name" class="ios-button p-1.5 rounded-xl flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 theme-text-primary" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg></button></div></div>
                    <div class="flex justify-between items-center"><span class="theme-text-secondary">Account No:</span><div class="flex items-center space-x-3"><span id="accNum" class="font-medium theme-text-primary">40003791171</span><button onclick="copyToClipboard('accNum', this)" title="Copy Account Number" class="ios-button p-1.5 rounded-xl flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 theme-text-primary" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg></button></div></div>
                    <div class="flex justify-between items-center"><span class="theme-text-secondary">IFSC Code:</span><div class="flex items-center space-x-3"><span id="ifscCode" class="font-medium theme-text-primary">SBIN0060236</span><button onclick="copyToClipboard('ifscCode', this)" title="Copy IFSC Code" class="ios-button p-1.5 rounded-xl flex-shrink-0"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 theme-text-primary" viewBox="0 0 20 20" fill="currentColor"><path d="M7 9a2 2 0 012-2h6a2 2 0 012 2v6a2 2 0 01-2 2H9a2 2 0 01-2-2V9z" /><path d="M5 3a2 2 0 00-2 2v6a2 2 0 002 2V5h6a2 2 0 00-2-2H5z" /></svg></button></div></div>
                </div>
            </div>
            <div class="space-y-4 pt-6">
                <h2 class="text-lg font-semibold theme-accent-color">5. Confirm on WhatsApp</h2>
                <p class="text-center text-sm theme-text-secondary">After payment, click the button below to send us the screenshot for confirmation.</p>
                <a href="https://wa.me/919824594156?text=Hello!%20I%20have%20completed%20the%20payment.%20Here%20is%20the%20screenshot." target="_blank" rel="noopener noreferrer" class="pay-button w-full font-bold py-3 px-4 rounded-xl flex items-center justify-center space-x-3 transition-all duration-300 transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.894 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654z"/></svg>
                    <span>Send Screenshot on WhatsApp</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Notification element for copy feedback -->
    <div id="toast-notification" class="glass-card theme-text-primary py-2 px-4 rounded-lg shadow-lg z-50">
        <!-- Message will be set by JS -->
    </div>

    <!-- Mandir Timing Modal -->
    <div id="timing-modal" class="modal-backdrop hidden">
        <!-- Updated max-width to 900px to fit side-by-side columns comfortably -->
        <div class="modal-content glass-card p-6 sm:p-8 relative flex flex-col" style="max-width: 900px;">
            <button id="close-timing-modal" class="absolute top-4 right-4 theme-text-secondary hover:theme-text-primary transition-colors text-3xl">&times;</button>
            <h2 class="text-3xl font-bold theme-accent-color page-title mb-4 text-center">Dwarkadhish Mandir & Dhwaja Timings</h2>
            <div id="timing-schedule" class="theme-text-secondary overflow-y-auto pr-4 space-y-2">
                <!-- Timings will be injected here by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="modal-backdrop hidden">
        <div class="modal-content glass-card p-6 sm:p-8 relative flex flex-col rounded-2xl text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100 mb-4">
                <svg class="h-6 w-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h2 class="text-2xl font-bold theme-text-primary mb-2">Message Sent!</h2>
            <p class="theme-text-secondary">Thank you for reaching out. We will get back to you shortly.</p>
        </div>
    </div>

    <script>
        // --- PASTE YOUR GOOGLE SHEET CSV LINK HERE ---
        const googleSheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSqINNmQ6CtGixfyo5goqhTKfVwIMGjQi_5MIc4FtTx053jXO2QftjgUt26XLQXE8Ld7kt7VEPK4TJO/pub?output=csv';
        // --- REPLACE THIS WITH YOUR SHEET 2 CSV LINK ---
        const googleSheetUrlPlaces = 'https://docs.google.com/spreadsheets/d/e/YOUR_SHEET_2_ID/pub?gid=YOUR_GID&output=csv'; 

        // --- GLOBAL VARIABLES ---
        let groupedData = {};
        // UPDATED PLACES DATA WITH DISTANCE FROM MANDIR AND RENTS
        let placesData = [
            {
                place_name: "Gomti Ghat & Samudra Narayan",
                distance: "0.5 km",
                auto_fare: "Walking / ‚Çπ30 Auto",
                timings: "6:00 AM - 8:00 PM",
                map_link: "https://maps.app.goo.gl/qgEyPLjzRE2SNZ588",
                address: "Gomti Ghat, Dwarka",
                description: "Sacred ghats for holy dip and a beautiful temple dedicated to Samudra Dev at the confluence.",
                image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Samudra_Narayan_Temple%2C_Dwarka.jpg/640px-Samudra_Narayan_Temple%2C_Dwarka.jpg" 
            },
            {
                place_name: "Bhadkeshwar Mahadev Mandir",
                distance: "2 km",
                auto_fare: "‚Çπ100 - ‚Çπ150 (Auto Round Trip)",
                timings: "Open all day",
                map_link: "https://maps.app.goo.gl/fMXMhXtg4bVP6QWZ6",
                address: "Near Geeta Mandir, Dwarka",
                description: "A serene Shiva temple on a hillock in the sea, offering breathtaking sunset views.",
                image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/c/c5/Samudra_Narayan_Temple%2C_Dwarka.jpg/640px-Samudra_Narayan_Temple%2C_Dwarka.jpg" 
            },
            {
                place_name: "Rukmini Devi Mandir",
                distance: "2.5 km",
                auto_fare: "‚Çπ150 - ‚Çπ200 (Auto Round Trip)",
                timings: "6:00 AM - 12:00 PM, 5:00 PM - 9:00 PM",
                map_link: "https://maps.app.goo.gl/KuLpifHa69izgFJa9",
                address: "Rukmini Devi Temple, Dwarka",
                description: "Dedicated to Rukmini, Lord Krishna's chief queen. Known for its rich carvings and history.",
                image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/Rukmini_Devi_Temple%2C_Dwarka.jpg/640px-Rukmini_Devi_Temple%2C_Dwarka.jpg" 
            },
            {
                place_name: "Nageshwar Jyotirling",
                distance: "17 km",
                auto_fare: "‚Çπ700 - ‚Çπ900 (Auto Round Trip)",
                timings: "6:00 AM - 12:30 PM, 5:00 PM - 9:30 PM",
                map_link: "https://maps.app.goo.gl/xbQcvMzDo2saKZHz8",
                address: "Daarukavanam, Gujarat 361335",
                description: "One of the 12 Jyotirlingas of Lord Shiva. Features a giant statue of Lord Shiva.",
                image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/3/32/Nageshwar_Jyotirlinga_Temple_Dwarka.jpg/640px-Nageshwar_Jyotirlinga_Temple_Dwarka.jpg" 
            },
            {
                place_name: "Gopi Talav",
                distance: "22 km",
                auto_fare: "Part of Full Day Tour",
                timings: "6:00 AM - 6:00 PM",
                map_link: "https://maps.app.goo.gl/xggHDjCrRURNmz5s8",
                address: "Gopi Talav, Dwarka",
                description: "A sacred pond associated with the Gopis of Vrindavan and Lord Krishna's Raas Leela.",
                image_url: "" 
            },
            {
                place_name: "Shivrajpur Beach",
                distance: "13 km",
                auto_fare: "‚Çπ600 - ‚Çπ800 (Auto Round Trip)",
                timings: "8:00 AM - 7:00 PM",
                map_link: "https://maps.app.goo.gl/PCenDXDfC9QhvqAN7",
                address: "Shivrajpur, Gujarat",
                description: "Blue Flag certified pristine beach with white sand and clear water. Ideal for water sports.",
                image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/a/a9/Shivrajpur_Beach.jpg/640px-Shivrajpur_Beach.jpg" 
            },
            {
                place_name: "Bet Dwarka (Okha Jetty)",
                distance: "32 km",
                auto_fare: "Taxi: ‚Çπ1200-‚Çπ1500 / Bus: ‚Çπ40",
                timings: "Ferry runs 6:00 AM to 7:00 PM",
                map_link: "https://maps.app.goo.gl/mLiwWCAyp1B3ewVu5",
                address: "Bet Dwarka Island",
                description: "The original residence of Lord Krishna. Requires a ferry ride from Okha port.",
                image_url: "https://upload.wikimedia.org/wikipedia/commons/thumb/8/82/Dwarkadhish_Temple_Dwarka.jpg/640px-Dwarkadhish_Temple_Dwarka.jpg" 
            },
            {
                place_name: "Dwarka Light House",
                distance: "2 km",
                auto_fare: "‚Çπ100 (Auto)",
                timings: "4:00 PM - 6:00 PM",
                map_link: "https://maps.app.goo.gl/VHXm2BuMHnY4eZdN8",
                address: "Near Bhadkeshwar, Dwarka",
                description: "Offers panoramic views of the Arabian Sea and the city. Best visited in the evening.",
                image_url: "" 
            }
        ];
        
        // --- Dummy Data for Places (Will be replaced by sheet data if provided) ---
        const dummyPlacesData = [];

        const poonamDates = [
            { year: 2025, month: 'August', day: 9 }, { year: 2025, month: 'September', day: 7 },
            { year: 2025, month: 'October', day: 7 }, { year: 2025, month: 'November', day: 5 },
            { year: 2025, month: 'December', day: 5 }, { year: 2026, month: 'January', day: 3 },
            { year: 2026, month: 'February', day: 2 }, { year: 2026, month: 'March', day: 3 },
            { year: 2026, month: 'April', day: 2 }, { year: 2026, month: 'May', day: 1 },
            { year: 2026, month: 'May', day: 31 }, { year: 2026, month: 'June', day: 30 },
            { year: 2026, month: 'July', day: 29 }, { year: 2026, month: 'August', day: 28 },
            { year: 2026, month: 'September', day: 26 }, { year: 2026, month: 'October', day: 26 },
            { year: 2026, month: 'November', day: 24 }, { year: 2026, month: 'December', day: 24 },
            { year: 2027, month: 'January', day: 22 }, { year: 2027, month: 'February', day: 21 },
            { year: 2027, month: 'March', day: 22 }, { year: 2027, month: 'April', day: 21 },
            { year: 2027, month: 'May', day: 20 }, { year: 2027, month: 'June', day: 19 },
            { year: 2027, month: 'July', day: 18 }, { year: 2027, month: 'August', day: 17 },
            { year: 2027, month: 'September', day: 15 }, { year: 2027, month: 'October', day: 15 },
            { year: 2027, month: 'November', day: 13 }, { year: 2027, month: 'December', day: 13 }
        ];

        // --- DOM Element References ---
        const welcomePopup = document.getElementById('welcome-popup');
        const datesContainer = document.getElementById('poonam-dates-container');
        const countdownContainer = document.getElementById('countdown-container');
        const modal = document.getElementById('ticketModal');
        const iframe = document.getElementById('ticketViewerIframe');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const aboutModal = document.getElementById('about-modal');
        const contactModal = document.getElementById('contact-modal');
        const paymentModal = document.getElementById('payment-modal');
        const timingModal = document.getElementById('timing-modal');
        const placesModal = document.getElementById('places-modal');
        const placesContainer = document.getElementById('places-container');
        const contactForm = document.getElementById('contact-form');
        const successModal = document.getElementById('success-modal');
        const yearFilter = document.getElementById('year-filter');
        const dateMonthFilter = document.getElementById('date-month-filter');

        const cardColors = {
            travel: {
                'confirmed': { header: 'bg-emerald-600', chip: 'bg-white text-emerald-800', train: '#059669', durationCircle: 'bg-emerald-50 border-emerald-200', durationText: 'text-emerald-800', icon: '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>' },
                'pending': { header: 'bg-amber-500', chip: 'bg-white text-amber-800', train: '#d97706', durationCircle: 'bg-amber-50 border-amber-200', durationText: 'text-amber-800', icon: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>' },
                'not-booked': { header: 'bg-red-600', chip: 'bg-white text-red-800', train: '#dc2626', durationCircle: 'bg-red-50 border-red-200', durationText: 'text-red-800', icon: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>' },
                'no-stay': { header: 'bg-slate-600', chip: 'bg-white text-slate-800', icon: '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>' }
            },
            stay: {
                'confirmed': { header: 'bg-indigo-600', chip: 'bg-white text-indigo-800', icon: '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>' },
                'pending': { header: 'bg-orange-500', chip: 'bg-white text-orange-800', icon: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>' },
                'not-booked': { header: 'bg-rose-600', chip: 'bg-white text-rose-800', icon: '<path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>' },
                'no-stay': { header: 'bg-slate-600', chip: 'bg-white text-slate-800', icon: '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>' }
            }
        };

        // --- Helper function to get Day Name ---
        function getWeekdayName(dateStr) {
            if (!dateStr) return '';
            try {
                const parts = dateStr.split(/[\/\-]/);
                let dateObj;
                if (parts.length === 3 && parts[2].length === 4) {
                    dateObj = new Date(parts[2], parts[1] - 1, parts[0]);
                } else {
                    dateObj = new Date(dateStr);
                }
                if (isNaN(dateObj.getTime())) return '';
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                return days[dateObj.getDay()];
            } catch (e) { return ''; }
        }

        // Helper for direct text copying
        window.copyText = function(text) {
            if (!text) return;
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.position = "fixed";
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showToast(`Copied: ${text}`);
                } else {
                    showToast('Failed to copy', 'error');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
                showToast('Failed to copy', 'error');
            }
            document.body.removeChild(textArea);
        };

        function showWelcomePopup() {
            if (!welcomePopup) return;
            welcomePopup.style.display = 'flex';
            setTimeout(() => {
                welcomePopup.classList.add('welcome-popup-visible');
                welcomePopup.querySelector('.welcome-content').classList.add('welcome-content-visible');
            }, 10);
            setTimeout(() => {
                welcomePopup.classList.remove('welcome-popup-visible');
                welcomePopup.querySelector('.welcome-content').classList.remove('welcome-content-visible');
                setTimeout(() => { welcomePopup.style.display = 'none'; }, 500);
            }, 2000);
        }

        function setupDropdowns() {
            const years = Object.keys(groupedData).sort();
            yearFilter.innerHTML = '<option value="">-- Select a Journey Year --</option>';
            years.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                yearFilter.appendChild(option);
            });
            dateMonthFilter.innerHTML = '<option value="">-- First, Choose a Year --</option>';
            dateMonthFilter.disabled = true;
            datesContainer.innerHTML = `<p class="text-center theme-text-secondary p-10">Please select a year and date to see booking details.</p>`;
        }

        // --- NEW: Function to Populate Date/Month Dropdown Independently ---
        function populateDateMonthDropdown(selectedYear) {
            dateMonthFilter.innerHTML = '<option value="">-- Select a Journey Date --</option>';
            
            if (selectedYear && groupedData[selectedYear]) {
                dateMonthFilter.disabled = false;
                const dateMonths = Object.keys(groupedData[selectedYear]);
                dateMonths.forEach(dm => {
                    const option = document.createElement('option');
                    option.value = dm;
                    
                    const fullDateString = `${dm} ${selectedYear}`;
                    const dayName = getWeekdayName(fullDateString);
                    option.textContent = dayName ? `${dm} (${dayName})` : dm;
                    
                    dateMonthFilter.appendChild(option);
                });
            } else {
                dateMonthFilter.innerHTML = '<option value="">-- First, Choose a Year --</option>';
                dateMonthFilter.disabled = true;
            }
        }

        // --- NEW: Auto Select Next Trip Function ---
        function autoSelectNextTrip() {
            const now = new Date();
            // Reset time to start of day for accurate comparison
            now.setHours(0,0,0,0);
            
            let targetYear = null;
            let targetDateMonth = null;

            // Find the next Poonam date from schedule that is >= today
            for (const date of poonamDates) {
                 const monthIndex = new Date(Date.parse(date.month +" 1, 2012")).getMonth();
                 const tripDate = new Date(date.year, monthIndex, date.day);

                 // Check if tripDate is today or future
                 if (tripDate >= now) {
                     const potentialYear = date.year.toString();
                     
                     // Try both "9 August" and "09 August" format to be safe
                     const dayStr = date.day.toString();
                     const paddedDayStr = dayStr.padStart(2, '0');
                     
                     const potentialDateMonth1 = `${dayStr} ${date.month}`; 
                     const potentialDateMonth2 = `${paddedDayStr} ${date.month}`;

                     // CRITICAL CHECK: Do we actually have data for this date in the CSV?
                     if (groupedData[potentialYear]) {
                         if (groupedData[potentialYear][potentialDateMonth1]) {
                             targetYear = potentialYear;
                             targetDateMonth = potentialDateMonth1;
                             break;
                         } else if (groupedData[potentialYear][potentialDateMonth2]) {
                             targetYear = potentialYear;
                             targetDateMonth = potentialDateMonth2;
                             break;
                         }
                     }
                 }
            }

            // If we found a valid upcoming trip with data, load it!
            if (targetYear && targetDateMonth) {
                // 1. Set Year Dropdown
                yearFilter.value = targetYear;
                
                // 2. Populate Date Dropdown based on Year
                populateDateMonthDropdown(targetYear);
                
                // 3. Set Date Dropdown
                dateMonthFilter.value = targetDateMonth;
                
                // 4. Render the cards
                renderCards(targetYear, targetDateMonth);
            }
        }

        function startCountdown() {
            const now = new Date();
            let nextPoonamDate = null;

            for (const date of poonamDates) {
                const monthIndex = new Date(Date.parse(date.month +" 1, 2012")).getMonth();
                const poonamDateTime = new Date(date.year, monthIndex, date.day);
                if (poonamDateTime > now) {
                    nextPoonamDate = poonamDateTime;
                    break;
                }
            }

            if (!nextPoonamDate) {
                countdownContainer.innerHTML = `<h2 class="text-2xl text-center theme-accent-color">All scheduled journeys for this period are complete.</h2>`;
                return;
            }

            const nextPoonamMonthYear = `${nextPoonamDate.toLocaleString('default', { month: 'long' })} ${nextPoonamDate.getFullYear()}`;
            countdownContainer.innerHTML = `
                <div class="text-center">
                    <h2 class="text-3xl sm:text-4xl font-semibold theme-accent-color page-title">Next Journey Countdown: ${nextPoonamMonthYear}</h2>
                    <div id="countdown-timer" class="flex flex-wrap justify-center gap-2 sm:gap-4 lg:gap-8 mt-4">
                        <div class="countdown-item"><span id="days" class="text-4xl sm:text-6xl">00</span><p class="text-xs sm:text-sm">Days</p></div>
                        <div class="countdown-item"><span id="hours" class="text-4xl sm:text-6xl">00</span><p class="text-xs sm:text-sm">Hours</p></div>
                        <div class="countdown-item"><span id="minutes" class="text-4xl sm:text-6xl">00</span><p class="text-xs sm:text-sm">Minutes</p></div>
                        <div class="countdown-item"><span id="seconds" class="text-4xl sm:text-6xl">00</span><p class="text-xs sm:text-sm">Seconds</p></div>
                    </div>
                </div>
            `;

            const daysEl = document.getElementById('days');
            const hoursEl = document.getElementById('hours');
            const minutesEl = document.getElementById('minutes');
            const secondsEl = document.getElementById('seconds');

            const timerInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = nextPoonamDate - now;

                if (distance < 0) {
                    clearInterval(timerInterval);
                    startCountdown();
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                daysEl.textContent = String(days).padStart(2, '0');
                hoursEl.textContent = String(hours).padStart(2, '0');
                minutesEl.textContent = String(minutes).padStart(2, '0');
                secondsEl.textContent = String(seconds).padStart(2, '0');

            }, 1000);
        }

        const attachModalListeners = () => {
            document.querySelectorAll('.view-ticket-btn').forEach(button => {
                button.addEventListener('click', () => {
                    const ticketUrl = button.dataset.ticketUrl;
                    if (ticketUrl && ticketUrl.trim() !== '#' && ticketUrl !== 'undefined') {
                        iframe.src = ticketUrl;
                        downloadBtn.href = ticketUrl;
                        const fileName = ticketUrl.substring(ticketUrl.lastIndexOf('/') + 1);
                        downloadBtn.setAttribute('download', fileName);
                        modal.classList.remove('hidden');
                    } else {
                        showToast('Document not available right now.', 'error');
                    }
                });
            });
        };

        const closeModal = () => {
            if(modal) modal.classList.add('hidden');
            if(iframe) iframe.src = '';
        };

        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast-notification');
            toast.textContent = message;
            toast.style.background = type === 'error' ? 'var(--accent-color)' : '#28a745';
            toast.style.color = 'white';
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        };

        const updateButtonState = (button) => {
            const originalHTML = button.innerHTML;
            button.disabled = true;
            button.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 theme-text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>`;

            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.disabled = false;
            }, 2000);
        };

        window.copyToClipboard = function(elementId, button) {
            const textToCopy = document.getElementById(elementId).innerText;
            window.copyText(textToCopy);
            updateButtonState(button);
        };

        function attachCollapsibleListeners() {
            const triggers = document.querySelectorAll('.collapsible-trigger');
            triggers.forEach(trigger => {
                trigger.addEventListener('click', function() {
                    const content = this.nextElementSibling;
                    const isActive = this.classList.contains('active');
                    triggers.forEach(otherTrigger => {
                        if (otherTrigger !== this) {
                            otherTrigger.classList.remove('active');
                            otherTrigger.nextElementSibling.style.maxHeight = null;
                        }
                    });
                    if (isActive) {
                        this.classList.remove('active');
                        content.style.maxHeight = null;
                    } else {
                        this.classList.add('active');
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                });
            });
        }

        function renderCards(year, dateMonth) {
            const bookings = groupedData[year]?.[dateMonth];
            if (!bookings) {
                datesContainer.innerHTML = `<p class="text-center theme-text-secondary p-10">No bookings found for this date.</p>`;
                return;
            }
            let detailsHtml = '';
            let foundExpenseLink = null;
            bookings.forEach(item => {
                if (item.type === 'stay') detailsHtml += createStayCard(item);
                else if (item.type === 'travel') detailsHtml += createTravelCard(item);
                
                if (item.expenses_pdf_link && item.expenses_pdf_link.trim() !== '' && item.expenses_pdf_link.trim() !== '#') {
                    foundExpenseLink = item.expenses_pdf_link;
                }
            });
            detailsHtml += createExpenseCard(foundExpenseLink);
            datesContainer.innerHTML = detailsHtml;
            
            const cards = datesContainer.querySelectorAll('.card-item');
            cards.forEach((card, index) => {
                setTimeout(() => { card.classList.add('visible'); }, 100 * index);
            });
            attachModalListeners();
            attachCollapsibleListeners();
        }

        function createExpenseCard(link) {
            const hasLink = link && link !== '#';
            const buttonClass = hasLink 
                ? 'bg-purple-600/90 hover:bg-purple-700/90 text-white shadow-lg hover:shadow-purple-500/30' 
                : 'bg-gray-400/50 text-gray-200 cursor-not-allowed';
            const buttonText = hasLink ? 'View Expense Report' : 'No Expenses Available Right Now';
            const buttonIcon = hasLink ? '<i class="fas fa-file-pdf mr-2"></i>' : '<i class="fas fa-ban mr-2"></i>';
            const clickAttr = hasLink ? `data-ticket-url="${link}"` : 'disabled';

            return `
                <div class="glass-card overflow-hidden ticket-card card-item mt-8">
                    <div class="p-4 text-center relative bg-slate-700 text-white collapsible-trigger cursor-pointer">
                        <h2 class="text-lg sm:text-xl font-bold uppercase flex items-center justify-center gap-2">
                            <i class="fas fa-file-invoice-dollar"></i>
                            <span>Trip Expenses</span>
                        </h2>
                        <i class="fas fa-chevron-down chevron-icon absolute top-1/2 -translate-y-1/2 right-4 sm:right-6 text-white"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="p-8 flex flex-col items-center justify-center" style="background:var(--input-bg)">
                            <p class="theme-text-secondary mb-4 text-center text-sm">
                                ${hasLink ? 'Review the detailed breakdown of expenses for this journey.' : 'The expense report for this trip has not been uploaded yet.'}
                            </p>
                            <button ${clickAttr} class="view-ticket-btn w-full sm:w-auto px-8 py-3 rounded-xl font-bold transition-all duration-300 flex items-center justify-center ${buttonClass}">
                                ${buttonIcon}
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function createStayCard(stay) {
            let guestHtml = '';
            stay.passengers.forEach(guest => {
                guestHtml += `
                    <div class="flex items-center justify-between p-2 rounded-lg" style="background:var(--input-bg)">
                        <div class="flex items-center w-2/3">
                            <div class="bg-blue-300 text-blue-900 rounded-full h-6 w-6 flex items-center justify-center font-bold mr-2 text-xs flex-shrink-0">${guest.guest_initials}</div>
                            <p class="font-semibold theme-text-primary text-sm truncate">${guest.guest_name}</p>
                        </div>
                        <div class="text-right w-1/3">
                            <p class="text-sm theme-text-secondary">Amount</p>
                            <p class="font-bold theme-text-primary">‚Çπ ${guest.fare}</p>
                        </div>
                    </div>`;
            });
            const statusColors = cardColors.stay[stay.status] || cardColors.stay['no-stay'];
            const checkInDay = getWeekdayName(stay.check_in_date);
            const checkOutDay = getWeekdayName(stay.check_out_date);
            const mapQuery = encodeURIComponent(stay.name + " Dwarka");
            const mapUrl = `https://www.google.com/maps/search/?api=1&query=${mapQuery}`;

            return `
                <div class="glass-card overflow-hidden ticket-card card-item">
                    <div class="p-4 text-center relative ${statusColors.header} collapsible-trigger cursor-pointer flex flex-col justify-center items-center">
                        <div class="w-full flex justify-center items-center gap-2 mb-1">
                            <h2 class="text-lg sm:text-xl font-bold text-white uppercase flex items-center justify-center gap-2">
                                <i class="fas fa-bed"></i>
                                <span>Stay Information</span>
                            </h2>
                        </div>
                        <div class="flex items-center justify-center gap-3 text-white w-full">
                            <div class="flex flex-col items-end">
                                <span class="text-sm font-bold leading-tight">${stay.check_in_date}</span>
                                <span class="text-[10px] uppercase opacity-90 leading-tight">${checkInDay} ‚Ä¢ ${stay.check_in_time}</span>
                            </div>
                            <i class="fas fa-arrow-right text-xs opacity-75"></i>
                            <div class="flex flex-col items-start">
                                <span class="text-sm font-bold leading-tight">${stay.check_out_date}</span>
                                <span class="text-[10px] uppercase opacity-90 leading-tight">${checkOutDay} ‚Ä¢ ${stay.check_out_time}</span>
                            </div>
                        </div>
                        <div class="absolute top-1/2 -translate-y-1/2 left-4 sm:left-6 bg-white text-blue-800 text-xs sm:text-sm font-semibold px-2 sm:px-3 py-1 sm:py-1.5 rounded-full flex items-center shadow-sm z-20 ${statusColors.chip || ''}">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">${statusColors.icon}</svg>
                            <span>${stay.status.charAt(0).toUpperCase() + stay.status.slice(1)}</span>
                        </div>
                        <i class="fas fa-chevron-down chevron-icon absolute top-1/2 -translate-y-1/2 right-4 sm:right-6 text-white z-10"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="p-6">
                            <div class="flex justify-between items-start -mt-2 mb-4">
                                <div>
                                    <p class="text-sm theme-text-secondary">Hotel/Dharamshala/Guest House</p>
                                    <p class="font-semibold theme-text-primary text-lg">${stay.name}</p>
                                    ${stay.name ? `
                                    <a href="${mapUrl}" target="_blank" class="inline-flex items-center text-xs font-bold text-blue-500 hover:text-blue-600 mt-1 transition-colors">
                                        <i class="fas fa-map-marked-alt mr-1"></i> View on Google Maps
                                    </a>` : ''}
                                </div>
                                <div class="text-right">
                                    <p class="text-sm theme-text-secondary">Booking No.</p>
                                    <p class="font-mono font-bold theme-text-primary text-sm sm:text-base">${stay.booking_no_pnr}</p>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-center justify-between text-center mt-8 space-y-4 sm:space-y-0">
                                <div class="w-full sm:w-1/3">
                                    <p class="text-sm theme-text-secondary">Check In</p>
                                    <p class="font-bold theme-text-primary flex items-center justify-center gap-2 mt-1">
                                        <i class="fas fa-calendar-days theme-text-secondary"></i><span>${stay.check_in_date} <span class="text-xs opacity-75">(${checkInDay})</span></span>
                                    </p>
                                    <p class="theme-text-secondary text-sm flex items-center justify-center gap-2">
                                        <i class="fas fa-clock theme-text-secondary"></i><span>${stay.check_in_time}</span>
                                    </p>
                                </div>
                                <div class="w-full sm:w-1/3 flex justify-center">
                                    <div class="w-24 h-24 rounded-full flex flex-col items-center justify-center border-4" style="border-color: var(--accent-color); background-color: color-mix(in srgb, var(--accent-color) 15%, transparent);">
                                        <p class="font-bold theme-accent-color text-2xl">${stay.duration_days}</p>
                                        <p class="text-xs theme-accent-color">${stay.duration_hours}</p>
                                    </div>
                                </div>
                                <div class="w-full sm:w-1/3">
                                    <p class="text-sm theme-text-secondary">Check Out</p>
                                    <p class="font-bold theme-text-primary flex items-center justify-center gap-2 mt-1">
                                        <i class="fas fa-calendar-days theme-text-secondary"></i><span>${stay.check_out_date} <span class="text-xs opacity-75">(${checkOutDay})</span></span>
                                    </p>
                                    <p class="theme-text-secondary text-sm flex items-center justify-center gap-2">
                                        <i class="fas fa-clock theme-text-secondary"></i><span>${stay.check_out_time}</span>
                                    </p>
                                </div>
                            </div>
                            <div class="border-t pt-4 mt-8" style="border-color: var(--glass-border)">
                                <div class="space-y-2">${guestHtml}</div>
                            </div>
                        </div>
                        <div class="px-6 py-4" style="background:var(--input-bg)">
                            <button data-ticket-url="${stay.pdf_link}" class="view-ticket-btn w-full bg-blue-600/80 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700/80 transition duration-300 flex items-center justify-center ${!stay.pdf_link || stay.pdf_link === '#' ? 'opacity-50 cursor-not-allowed' : ''}">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                View Booking PDF
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        function createTravelCard(travel) {
            let passengerHtml = '';
            if (travel.passengers.length > 0 && travel.status !== 'not-booked') {
                travel.passengers.forEach(p => {
                    passengerHtml += `<div class="flex items-center justify-between p-2 rounded-lg" style="background:var(--input-bg)"><div class="flex items-center w-1/3"><div class="bg-gray-300 text-gray-800 rounded-full h-6 w-6 flex items-center justify-center font-bold mr-2 text-xs flex-shrink-0">${p.guest_initials}</div><p class="font-semibold theme-text-primary text-sm truncate">${p.guest_name}</p></div><div class="text-center w-1/3"><p class="font-semibold theme-text-primary text-sm">${p.seat_no}</p><p class="text-xs theme-text-secondary">${p.berth}</p></div><div class="text-right w-1/3"><p class="text-sm theme-text-secondary">Fare</p><p class="font-bold theme-text-primary">‚Çπ ${p.fare}</p></div></div>`;
                });
            } else if (travel.status === 'not-booked') {
                 passengerHtml = `<div class="text-center"><p class="theme-text-secondary">You have not booked a ticket for this journey.</p></div>`;
            }
            const statusColors = cardColors.travel[travel.status] || cardColors.travel['not-booked'];
            const startDay = getWeekdayName(travel.start_date);
            const endDay = getWeekdayName(travel.end_date);
            let pnrDisplayHtml = '';
            if (travel.booking_no_pnr) {
                const parts = travel.booking_no_pnr.toString().split(/[\/,]+/).map(s => s.trim());
                const pnrItems = parts.map(part => {
                    if (/^\d{10}$/.test(part)) {
                        const link = `https://www.confirmtkt.com/pnr-status/${part}`;
                        return `
                            <div class="flex items-center justify-end gap-2">
                                <a href="${link}" target="_blank" class="font-mono font-bold theme-text-primary hover:text-blue-500 transition-colors flex items-center gap-1" title="Check PNR Status">
                                    <i class="fas fa-ticket-alt theme-text-secondary text-xs"></i> 
                                    <span>${part}</span>
                                    <i class="fas fa-external-link-alt text-[10px] opacity-70"></i>
                                </a>
                                <button onclick="copyText('${part}')" class="text-gray-400 hover:text-green-500 transition-colors p-1" title="Copy PNR">
                                    <i class="far fa-copy text-xs"></i>
                                </button>
                            </div>
                        `;
                    } else {
                        return `<div class="font-mono font-bold theme-text-primary text-sm sm:text-base text-right">${part}</div>`;
                    }
                });
                pnrDisplayHtml = pnrItems.join('');
            } else {
                pnrDisplayHtml = `<span class="theme-text-secondary">-</span>`;
            }
            const trainNumber = travel.train_no; 
            const liveStatusLink = `https://www.confirmtkt.com/train-running-status/${trainNumber}`;

            return `
                <div class="glass-card overflow-hidden ticket-card card-item">
                    <div class="status-header p-4 text-center relative ${statusColors.header} collapsible-trigger cursor-pointer flex flex-col justify-center items-center">
                        <div class="w-full flex justify-center items-center gap-2 mb-1">
                            <h2 class="text-lg sm:text-xl font-bold text-white uppercase flex items-center justify-center gap-2">
                                <i class="fas fa-train-subway"></i>
                                <span>${travel.departure_city} to ${travel.arrival_city}</span>
                            </h2>
                        </div>
                        <div class="flex items-center justify-center gap-3 text-white w-full">
                            <div class="flex flex-col items-end">
                                <span class="text-sm font-bold leading-tight">${travel.start_date}</span>
                                <span class="text-[10px] uppercase opacity-90 leading-tight">${startDay} ‚Ä¢ ${travel.start_time}</span>
                            </div>
                            <i class="fas fa-arrow-right text-xs opacity-75"></i>
                            <div class="flex flex-col items-start">
                                <span class="text-sm font-bold leading-tight">${travel.end_date}</span>
                                <span class="text-[10px] uppercase opacity-90 leading-tight">${endDay} ‚Ä¢ ${travel.end_time}</span>
                            </div>
                        </div>
                        <div class="absolute top-1/2 -translate-y-1/2 left-4 sm:left-6 bg-white text-blue-800 text-xs sm:text-sm font-semibold px-2 sm:px-3 py-1 sm:py-1.5 rounded-full flex items-center shadow-sm z-20 ${statusColors.chip}">
                            <span class="status-icon w-4 h-4 mr-2"><svg fill="currentColor" viewBox="0 0 20 20">${statusColors.icon}</svg></span>
                            <span class="status-text">${statusColors.chipText || travel.status.charAt(0).toUpperCase() + travel.status.slice(1)}</span>
                        </div>
                        <i class="fas fa-chevron-down chevron-icon absolute top-1/2 -translate-y-1/2 right-4 sm:right-6 text-white z-10"></i>
                    </div>
                    <div class="collapsible-content">
                        <div class="p-6">
                            <div class="flex justify-between items-start -mt-2 mb-4">
                                <div>
                                    <p class="text-sm theme-text-secondary">Train</p>
                                    <a href="${liveStatusLink}" target="_blank" class="font-semibold theme-text-primary hover:text-blue-600 transition-colors flex items-center gap-1 group">
                                        ${travel.name} (${travel.train_no})
                                        <i class="fas fa-satellite-dish text-xs text-green-500 animate-pulse" title="Live Status"></i>
                                        <span class="text-xs text-blue-500 opacity-0 group-hover:opacity-100 transition-opacity">Check Status</span>
                                    </a>
                                </div>
                                <div class="pnr-container text-right flex flex-col items-end">
                                    <p class="text-sm theme-text-secondary mb-1">PNR</p>
                                    ${pnrDisplayHtml}
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row items-center justify-between text-center my-8 space-y-4 sm:space-y-0">
                                <div class="w-full sm:w-1/3 flex flex-col items-center">
                                    <p class="text-sm theme-text-secondary mb-1">Departure</p>
                                    <svg class="w-8 h-8 theme-text-secondary mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955a1.5 1.5 0 012.122 0l8.954 8.955M2.25 12v10.5a1.5 1.5 0 001.5 1.5h16.5a1.5 1.5 0 001.5-1.5V12M10.5 21V15a1.5 1.5 0 011.5-1.5h0a1.5 1.5 0 011.5 1.5v6" /></svg>
                                    <p class="font-bold theme-text-primary text-base sm:text-lg">${travel.departure_city}</p>
                                    <p class="theme-text-secondary text-sm flex items-center gap-1.5 mt-1"><i class="fas fa-calendar-days fa-xs"></i><span>${travel.start_date} <span class="text-xs opacity-75">(${startDay})</span></span></p>
                                    <p class="theme-text-secondary text-sm flex items-center gap-1.5"><i class="fas fa-clock fa-xs"></i><span>${travel.start_time}</span></p>
                                </div>
                                <div class="w-full sm:w-1/3 px-2 train-container">
                                    <div class="train-track"><i class="fas fa-train fa-lg train" style="color: ${statusColors.train};"></i></div>
                                    <div class="status-duration-circle w-24 h-24 rounded-full flex flex-col items-center justify-center relative z-10 border-[6px] ${statusColors.durationCircle}">
                                        <p class="status-duration-text font-bold text-lg ${statusColors.durationText}">${travel.duration_days}</p>
                                        <p class="text-xs ${statusColors.durationText}">${travel.duration_hours}</p>
                                    </div>
                                </div>
                                <div class="w-full sm:w-1/3 flex flex-col items-center">
                                    <p class="text-sm theme-text-secondary mb-1">Arrival</p>
                                    <svg class="w-8 h-8 theme-text-secondary mb-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 21v-8.25M15.75 21v-8.25M8.25 21v-8.25M3 9l9-6 9 6m-1.5 12V10.332A48.36 48.36 0 0012 9.75c-2.551 0-5.056.2-7.5.582V21M3 21h18M12 6.75h.008v.008H12V6.75z" /></svg>
                                    <p class="font-bold theme-text-primary text-base sm:text-lg">${travel.arrival_city}</p>
                                    <p class="theme-text-secondary text-sm flex items-center gap-1.5 mt-1"><i class="fas fa-calendar-days fa-xs"></i><span>${travel.end_date} <span class="text-xs opacity-75">(${endDay})</span></span></p>
                                    <p class="theme-text-secondary text-sm flex items-center gap-1.5"><i class="fas fa-clock fa-xs"></i><span>${travel.end_time}</span></p>
                                </div>
                            </div>
                            <div class="passenger-details-container border-t pt-4 space-y-2" style="border-color: var(--glass-border)">
                                ${passengerHtml}
                            </div>
                        </div>
                        <div class="px-6 py-4" style="background:var(--input-bg)">
                            <button data-ticket-url="${travel.pdf_link}" class="view-ticket-btn w-full ${travel.status === 'confirmed' ? 'bg-green-600/80 hover:bg-green-700/80' : 'bg-red-600/80 hover:bg-red-700/80'} text-white font-bold py-3 px-4 rounded-lg transition duration-300 flex items-center justify-center ${!travel.pdf_link || travel.pdf_link === '#' ? 'opacity-50 cursor-not-allowed' : ''}">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                View Booking PDF
                            </button>
                        </div>
                    </div>
                </div>`;
        }

        // --- NEW: Render Nearby Places Function ---
        function renderPlaces() {
            const dataToRender = placesData.length > 0 ? placesData : dummyPlacesData;
            
            if (dataToRender.length === 0) {
                placesContainer.innerHTML = `<p class="text-center theme-text-secondary">No places information available at the moment.</p>`;
                return;
            }

            let html = '<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">';
            
            dataToRender.forEach(place => {
                const imgUrl = place.image_url && place.image_url.trim() !== '' 
                    ? place.image_url 
                    : 'https://placehold.co/600x400/orange/white?text=' + encodeURIComponent(place.place_name);

                html += `
                    <div class="place-card rounded-xl overflow-hidden shadow-lg border border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 flex flex-col h-full">
                        <div class="h-48 overflow-hidden relative group">
                            <img src="${imgUrl}" alt="${place.place_name}" class="w-full h-full object-cover transition-transform duration-500 group-hover:scale-110">
                            <div class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-black/80 to-transparent p-4">
                                <h3 class="text-xl font-bold text-white">${place.place_name}</h3>
                                <p class="text-yellow-300 text-xs font-semibold"><i class="fas fa-road mr-1"></i> ${place.distance} from Mandir</p>
                            </div>
                        </div>
                        <div class="p-4 flex-grow flex flex-col justify-between">
                            <div class="space-y-2 mb-4">
                                ${place.description ? `<p class="text-sm theme-text-secondary line-clamp-2 mb-3">${place.description}</p>` : ''}
                                
                                <div class="flex items-start text-sm theme-text-secondary">
                                    <i class="fas fa-clock mt-1 mr-2 w-4 text-center theme-accent-color"></i>
                                    <span>${place.timings}</span>
                                </div>
                                
                                <div class="flex items-start text-sm theme-text-secondary">
                                    <i class="fas fa-taxi mt-1 mr-2 w-4 text-center theme-accent-color"></i>
                                    <span><strong>Rent:</strong> ${place.auto_fare}</span>
                                </div>
                                
                                <div class="flex items-start text-sm theme-text-secondary">
                                    <i class="fas fa-map-marker-alt mt-1 mr-2 w-4 text-center theme-accent-color"></i>
                                    <span class="line-clamp-1">${place.address}</span>
                                </div>
                            </div>
                            
                            <a href="${place.map_link}" target="_blank" class="w-full bg-blue-100 hover:bg-blue-200 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 dark:hover:bg-blue-800/50 py-2 rounded-lg text-center font-semibold text-sm transition-colors flex items-center justify-center gap-2">
                                <i class="fas fa-location-arrow"></i> Navigate
                            </a>
                        </div>
                    </div>
                `;
            });
            
            html += '</div>';
            placesContainer.innerHTML = html;
        }

        // --- NEW: Fetch Places Data Function ---
        async function fetchPlacesData() {
            if (googleSheetUrlPlaces.includes('YOUR_SHEET_2_ID')) {
                renderPlaces();
                return;
            }

            try {
                const response = await fetch(`${googleSheetUrlPlaces}&_=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const csvText = await response.text();
                placesData = parseCSV(csvText);
                renderPlaces();
            } catch (error) {
                console.error('Error fetching places data:', error);
                renderPlaces();
            }
        }

        // --- Function to parse CSV ---
        function parseCSV(csvText) {
            const lines = csvText.split(/\r?\n/).filter(line => line.trim());
            if (lines.length < 2) return [];
            const headers = lines[0].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(h => h.trim().replace(/"/g, '').toLowerCase().replace(/\s+/g, '_'));
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const obj = {};
                const currentline = lines[i].split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(item => item.trim().replace(/"/g, ''));
                if (currentline.length === headers.length) {
                    for (let j = 0; j < headers.length; j++) {
                        obj[headers[j]] = currentline[j];
                    }
                    data.push(obj);
                }
            }
            return data;
        }

        // --- Function to fetch and process data ---
        async function fetchAndProcessData() {
            if (!googleSheetUrl || googleSheetUrl.includes('YOUR_GOOGLE_SHEET')) {
                datesContainer.innerHTML = `<p class="text-center text-red-400 p-10">Please add your Google Sheet CSV link in the script.</p>`;
                return;
            }

            datesContainer.innerHTML = `
                <div class="text-center p-10">
                    <svg aria-hidden="true" class="inline w-10 h-10 theme-text-secondary animate-spin" style="fill: var(--accent-color)" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M100 50.5908C100 78.2051 77.6142 100.591 50 100.591C22.3858 100.591 0 78.2051 0 50.5908C0 22.9766 22.3858 0.59082 50 0.59082C77.6142 0.59082 100 22.9766 100 50.5908ZM9.08144 50.5908C9.08144 73.1895 27.4013 91.5094 50 91.5094C72.5987 91.5094 90.9186 73.1895 90.9186 50.5908C90.9186 27.9921 72.5987 9.67226 50 9.67226C27.4013 9.67226 9.08144 27.9921 9.08144 50.5908Z" fill="currentColor"/>
                        <path d="M93.9676 39.0409C96.393 38.4038 97.8624 35.9116 97.0079 33.5539C95.2932 28.8227 92.871 24.3692 89.8167 20.348C85.8452 15.1192 80.8826 10.7238 75.2124 7.41289C69.5422 4.10194 63.2754 1.94025 56.7698 1.05124C51.7666 0.367541 46.6976 0.446843 41.7345 1.27873C39.2613 1.69328 37.813 4.19778 38.4501 6.62326C39.0873 9.04874 41.5694 10.4717 44.0505 10.1071C47.8511 9.54855 51.7191 9.52689 55.5402 10.0492C60.8642 10.7766 65.9928 12.5457 70.6331 15.2552C75.2735 17.9648 79.3347 21.5619 82.5849 25.841C84.9175 28.9121 86.7997 32.2913 88.1811 35.8758C89.083 38.2158 91.5421 39.6781 93.9676 39.0409Z" fill="currentColor"/>
                    </svg>
                    <p class="mt-4 theme-text-secondary font-semibold">Loading booking data...</p>
                </div>`;

            try {
                const response = await fetch(`${googleSheetUrl}&_=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);

                const csvText = await response.text();
                const allBookingsData = parseCSV(csvText);

                groupedData = allBookingsData.reduce((acc, row) => {
                    if (row.year && row.date_month) {
                        const { year, date_month } = row;
                        if (!acc[year]) acc[year] = {};
                        if (!acc[year][date_month]) acc[year][date_month] = [];

                        const key = `${row.type}-${row.booking_no_pnr || Math.random()}`;
                        let booking = acc[year][date_month].find(b => b.key === key);

                        if (!booking) {
                            booking = { ...row, passengers: [], key: key };
                            acc[year][date_month].push(booking);
                        }

                        if (row.guest_name) {
                            booking.passengers.push(row);
                        }
                    }
                    return acc;
                }, {});

                setupDropdowns();
                // --- TRIGGER AUTO SELECT ---
                autoSelectNextTrip();

            } catch (error) {
                console.error('Error fetching or processing data:', error);
                datesContainer.innerHTML = `<p class="text-center text-red-400 p-10">Error loading booking data. Please check the data source and network connection.</p>`;
            }
        }

        // --- Mandir Timing Function ---
        const populateTimings = () => {
            const scheduleContainer = document.getElementById('timing-schedule');
            const now = new Date();
            const currentTime = now.getHours() + now.getMinutes() / 60;
            
            const mandirTimings = [
                { time: "6:30 AM", event: "Mangla Aarti", type: "open", start: 6.5, end: 8.0 },
                { time: "8:00 AM - 9:00 AM", event: "Mangla Darshan", type: "open", start: 8.0, end: 9.0 },
                { time: "9:00 AM - 9:30 AM", event: "Abhishek Pooja (Closed)", type: "closed", start: 9.0, end: 9.5 },
                { time: "9:30 AM - 10:15 AM", event: "Shringar Darshan", type: "open", start: 9.5, end: 10.25 },
                { time: "10:15 AM - 10:30 AM", event: "Shringar Bhog (Closed)", type: "closed", start: 10.25, end: 10.5 },
                { time: "10:30 AM - 10:45 AM", event: "Shringar Aarti", type: "open", start: 10.5, end: 10.75 },
                { time: "11:05 AM - 11:20 AM", event: "Gwal Bhog (Closed)", type: "closed", start: 11.08, end: 11.33 },
                { time: "11:20 AM - 12:00 PM", event: "Darshan Open", type: "open", start: 11.33, end: 12.0 },
                { time: "12:00 PM - 12:20 PM", event: "Rajbhog (Closed)", type: "closed", start: 12.0, end: 12.33 },
                { time: "12:20 PM - 1:00 PM", event: "Darshan Open", type: "open", start: 12.33, end: 13.0 },
                { time: "1:00 PM - 5:00 PM", event: "Anosar (Mandir Closed)", type: "closed", start: 13.0, end: 17.0 },
                { time: "5:00 PM - 5:30 PM", event: "Uthapan Darshan", type: "open", start: 17.0, end: 17.5 },
                { time: "5:45 PM - 6:00 PM", event: "Uthapan Bhog (Closed)", type: "closed", start: 17.75, end: 18.0 },
                { time: "6:15 PM - 6:45 PM", event: "Darshan Open", type: "open", start: 18.25, end: 18.75 },
                { time: "7:00 PM - 7:25 PM", event: "Sandhya Bhog (Closed)", type: "closed", start: 19.0, end: 19.42 },
                { time: "7:25 PM - 7:45 PM", event: "Sandhya Aarti", type: "open", start: 19.42, end: 19.75 },
                { time: "8:00 PM - 8:10 PM", event: "Shayan Bhog (Closed)", type: "closed", start: 20.0, end: 20.17 },
                { time: "8:10 PM - 8:35 PM", event: "Shayan Darshan", type: "open", start: 20.17, end: 20.58 },
                { time: "8:35 PM", event: "Shayan Aarti", type: "open", start: 20.58, end: 21.0 },
                { time: "9:00 PM", event: "Mandir Closed", type: "closed", start: 21.0, end: 24.0 }
            ];

            const dhwajaTimings = [
                { event: "First Dhwaja Arohan", time: "7:00 AM - 8:30 AM", start: 7.0, end: 8.5 },
                { event: "Second Dhwaja Arohan", time: "8:39 AM - 10:30 AM", start: 8.65, end: 10.5 },
                { event: "Third Dhwaja Arohan", time: "10:30 AM - 12:30 PM", start: 10.5, end: 12.5 },
                { event: "Fourth Dhwaja Arohan", time: "5:30 PM", start: 17.0, end: 18.5 } 
            ];

            let mandirHtml = '';
            mandirTimings.forEach(item => {
                const isCurrent = currentTime >= item.start && currentTime < item.end;
                const colorClass = item.type === 'open' ? 'text-green-500' : 'text-red-400';
                const currentClass = isCurrent ? 'current-timing ring-2 ring-offset-1 ring-orange-400' : '';

                mandirHtml += `
                    <div class="flex justify-between items-center p-2 rounded-lg ${currentClass} hover:bg-black/5 dark:hover:bg-white/5 transition-colors text-sm mb-1">
                        <span class="font-medium theme-text-primary">${item.event}</span>
                        <span class="${colorClass} font-bold text-right ml-2 whitespace-nowrap">${item.time}</span>
                    </div>
                `;
            });

            let dhwajaHtml = '';
            dhwajaTimings.forEach(item => {
                const isCurrent = currentTime >= item.start && currentTime < item.end;
                const activeClass = isCurrent ? 'current-timing ring-2 ring-offset-1 ring-orange-400' : '';
                const timeColor = isCurrent ? 'text-green-500' : 'theme-accent-color';

                dhwajaHtml += `
                    <div class="flex justify-between items-center p-3 rounded-lg ${activeClass} hover:bg-black/5 dark:hover:bg-white/5 transition-colors text-sm mb-2 shadow-sm" style="background:var(--input-bg)">
                        <span class="font-medium theme-text-primary flex items-center gap-2">
                            <i class="fas fa-flag theme-accent-color text-xs"></i> ${item.event}
                        </span>
                        <span class="${timeColor} font-bold text-right ml-2 whitespace-nowrap">${item.time}</span>
                    </div>
                `;
            });

            scheduleContainer.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                    <!-- Mandir Darshan Column -->
                    <div>
                        <div class="sticky top-0 bg-white/10 backdrop-blur-md z-10 py-2 mb-2 border-b border-gray-500/20">
                            <h3 class="text-xl font-bold theme-text-primary text-center flex items-center justify-center gap-2">
                                <i class="fas fa-gopuram theme-accent-color"></i> Darshan Timing
                            </h3>
                        </div>
                        <div class="space-y-1">
                            ${mandirHtml}
                        </div>
                    </div>

                    <!-- Dhwaja Arohan Column -->
                    <div>
                        <div class="sticky top-0 bg-white/10 backdrop-blur-md z-10 py-2 mb-2 border-b border-gray-500/20">
                            <h3 class="text-xl font-bold theme-text-primary text-center flex items-center justify-center gap-2">
                                <i class="fas fa-flag theme-accent-color"></i> Dhwaja Timing
                            </h3>
                        </div>
                        <div class="space-y-1">
                            ${dhwajaHtml}
                            <div class="mt-4 p-3 rounded-lg bg-orange-100/10 border border-orange-500/30 text-xs theme-text-secondary text-center">
                                <p><i class="fas fa-info-circle mr-1"></i> Note: Dhwaja timings are subject to change during festivals.</p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        document.addEventListener('DOMContentLoaded', async function() {
            // ... existing theme toggle logic ...
            const themeToggle = document.getElementById('theme-toggle');
            const sunIcon = document.getElementById('sun-icon');
            const moonIcon = document.getElementById('moon-icon');
            const htmlTag = document.documentElement;

            function updateThemeIcons(isDarkMode) {
                moonIcon.classList.toggle('hidden', !isDarkMode);
                sunIcon.classList.toggle('hidden', isDarkMode);
            }
            themeToggle.addEventListener('click', () => {
                htmlTag.classList.toggle('dark');
                htmlTag.classList.toggle('light');
                const isDarkMode = htmlTag.classList.contains('dark');
                localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
                updateThemeIcons(isDarkMode);
            });
            const savedTheme = localStorage.getItem('theme');
            const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const isDark = savedTheme === 'dark' || (!savedTheme && systemPrefersDark);
            htmlTag.classList.toggle('dark', isDark);
            htmlTag.classList.toggle('light', !isDark);
            updateThemeIcons(isDark);

            // --- Original Event Listeners ---
            if(closeModalBtn) closeModalBtn.addEventListener('click', closeModal);
            if(modal) modal.addEventListener('click', (event) => { if (event.target === modal) closeModal(); });

            document.querySelectorAll('#about-link, #mobile-about-link').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); aboutModal.classList.remove('hidden'); });
            });
            document.querySelectorAll('#contact-link, #mobile-contact-link').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); contactModal.classList.remove('hidden'); });
            });
            document.querySelectorAll('#pay-link, #mobile-pay-link').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); paymentModal.classList.remove('hidden'); });
            });
            document.querySelectorAll('#timing-link, #mobile-timing-link').forEach(link => {
                link.addEventListener('click', (e) => { e.preventDefault(); timingModal.classList.remove('hidden'); });
            });
            document.querySelectorAll('#places-link, #mobile-places-link').forEach(link => {
                link.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    placesModal.classList.remove('hidden'); 
                    if(placesContainer.innerHTML.includes('Loading')) {
                        fetchPlacesData(); 
                    }
                });
            });

            document.getElementById('close-about-modal').addEventListener('click', () => aboutModal.classList.add('hidden'));
            document.getElementById('close-contact-modal').addEventListener('click', () => contactModal.classList.add('hidden'));
            document.getElementById('close-payment-modal').addEventListener('click', () => paymentModal.classList.add('hidden'));
            document.getElementById('close-timing-modal').addEventListener('click', () => timingModal.classList.add('hidden'));
            document.getElementById('close-places-modal').addEventListener('click', () => placesModal.classList.add('hidden'));

            [aboutModal, contactModal, paymentModal, timingModal, successModal, placesModal].forEach(m => {
                 m.addEventListener('click', (e) => { if(e.target === m) m.classList.add('hidden'); });
            });

            contactForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                const form = e.target;
                const data = new FormData(form);
                try {
                    const response = await fetch(form.action, {
                        method: form.method,
                        body: data,
                        headers: { 'Accept': 'application/json' }
                    });
                    if (response.ok) {
                        contactModal.classList.add('hidden');
                        successModal.classList.remove('hidden');
                        form.reset();
                        setTimeout(() => { successModal.classList.add('hidden'); }, 3000);
                    } else {
                        console.error("Oops! There was a problem submitting your form.");
                    }
                } catch (error) {
                    console.error("Oops! There was a problem submitting your form.");
                }
            });

            document.getElementById('mobile-menu-button').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.toggle('hidden');
            });

            document.getElementById('home-link').addEventListener('click', (e) => { e.preventDefault(); window.location.reload(); });
            document.getElementById('mobile-home-link').addEventListener('click', (e) => { e.preventDefault(); window.location.reload(); });

            // --- REFACTORED YEAR FILTER LOGIC ---
            yearFilter.addEventListener('change', (e) => {
                const selectedYear = e.target.value;
                datesContainer.innerHTML = '';
                populateDateMonthDropdown(selectedYear); // Using the new helper function
            });

            dateMonthFilter.addEventListener('change', (e) => {
                const selectedDateMonth = e.target.value;
                const selectedYear = yearFilter.value;
                if (selectedDateMonth && selectedYear) {
                    renderCards(selectedYear, selectedDateMonth);
                } else {
                    datesContainer.innerHTML = '';
                }
            });

            // --- Initial calls to set up the site ---
            await fetchAndProcessData();
            startCountdown();
            populateTimings();
            showWelcomePopup();
            fetchPlacesData();
        });
    </script>
</body>
</html>
